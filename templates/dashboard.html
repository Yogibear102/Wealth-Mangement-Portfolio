{# dashboard.html - Asset allocation and portfolio overview #}
{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<style>
.equity-overlay {
  background: #ffffff;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.equity-item {
  margin-bottom: 1rem;
}

.equity-label {
  font-size: 0.875rem;
  color: #858796;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.equity-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #5a5c69;
  margin: 0.25rem 0;
}

.refresh-btn {
  background: none;
  border: none;
  color: #4e73df;
  font-size: 0.75rem;
  padding: 0;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s ease;
}

.refresh-btn:hover {
  color: #2e59d9;
}
</style>

<div class="container mt-4">
  <!-- Chart Section with Equity Overlay -->
  <div class="row align-items-center mb-5">
    <div class="col-md-6 text-center">
      <h5 class="fw-semibold text-secondary mb-3">Asset Allocation</h5>
      <canvas id="allocChart" style="max-width: 350px; height: 350px; margin: auto;"></canvas>
      <div id="chartLegend" class="mt-3"></div>
    </div>
    <div class="col-md-6">
      <div class="equity-overlay">
        <div class="equity-item">
          <div class="equity-label">Net Worth</div>
          <div class="equity-value text-success">{{ '{:,.2f}'.format(total) }} {{ base_currency }}</div>
        </div>
        <div class="equity-item">
          <div class="equity-label">Liquid Equity</div>
          <div class="equity-value text-info">{{ '{:,.2f}'.format(user.liquid_equity) }} {{ base_currency }}</div>
          <form method="POST" action="{{ url_for('refresh_equity') }}" style="display: inline;">
            <button type="submit" class="refresh-btn" title="Add monthly income to liquid equity">refresh</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Assets Table -->
  <div class="mt-5">
    <h5 class="fw-semibold text-secondary mb-3">Your Assets</h5>
    
    {% if assets %}
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th>Asset Name</th>
          <th>Type</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>Currency</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for asset in assets %}
        <tr>
          <td class="fw-semibold">{{ asset.name }}</td>
          <td><span class="badge bg-info">{{ asset.asset_type|capitalize }}</span></td>
          <td>{{ '%.2f'|format(asset.quantity) }}</td>
          <td class="text-success fw-bold">{{ '{:,.2f}'.format(asset.current_value) }}</td>
          <td>{{ asset.currency }}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="sellAsset({{asset.id}}, '{{asset.name}}', {{asset.quantity}}, '{{asset.symbol}}', '{{asset.asset_type}}')">Sell</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">
      No assets yet. <a href="{{ url_for('assets_buy') }}" class="alert-link">Add your first asset</a> to get started!
    </div>
    {% endif %}
  </div>
</div>

<!-- Sell Modal -->
<div class="modal fade" id="sellModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Sell Asset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="sellForm" method="POST">
        <div class="modal-body">
          <input type="hidden" name="asset_id" id="sell_asset_id">
          <input type="hidden" name="type" value="Sell">
          <p>Selling: <strong id="sell_asset_name"></strong></p>
          <div class="mb-3">
            <label class="form-label">Quantity to Sell</label>
            <input type="number" step="0.01" name="quantity" id="sell_quantity" class="form-control" required>
            <div class="form-text">Available: <span id="sell_max_quantity"></span></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Current Market Price per Unit</label>
            <input type="number" step="0.01" name="amount" id="sell_price" class="form-control" readonly>
            <div class="form-text text-muted">Fetching current price...</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-control" required value="{{ today }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Note (Optional)</label>
            <textarea name="note" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Sell</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  // Initialize chart with data from Flask
  initializeChart({{ labels|tojson }}, {{ values|tojson }}, {{ colors|tojson }});
</script>
{% endblock %}
