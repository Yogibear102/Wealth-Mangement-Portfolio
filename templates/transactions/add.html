{% extends 'base.html' %}
{% block title %}Add Asset{% endblock %}

{% block content %}
<style>
  .asset-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e3e6f0;
  }
  
  .form-card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #4e73df;
  }
  
  .form-card-header svg {
    width: 32px;
    height: 32px;
    stroke: #4e73df;
  }
  
  .form-card-header h2 {
    margin: 0;
    color: #4e73df;
    font-weight: 600;
  }
  
  .form-group-modern {
    margin-bottom: 1.5rem;
  }
  
  .form-group-modern label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #5a5c69;
    margin-bottom: 0.5rem;
  }
  
  .form-group-modern label svg {
    width: 18px;
    height: 18px;
    stroke: #858796;
  }
  
  .form-control-modern {
    border: 2px solid #e3e6f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  .form-control-modern:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
    outline: none;
  }
  
  .btn-modern {
    padding: 0.875rem 2rem;
    font-size: 1.05rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    transition: all 0.3s ease;
  }
  
  .btn-modern svg {
    width: 20px;
    height: 20px;
  }
  
  .btn-primary-modern {
    background: #4e73df;
    color: white;
  }
  
  .btn-primary-modern:hover {
    background: #2e59d9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(78, 115, 223, 0.4);
  }
  
  .btn-secondary-modern {
    background: #858796;
    color: white;
  }
  
  .btn-secondary-modern:hover {
    background: #6c6e7e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(133, 135, 150, 0.4);
  }
  
  .form-text-modern {
    color: #858796;
    font-size: 0.875rem;
    margin-top: 0.375rem;
  }
  
  .button-group {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }
</style>

<div class="container mt-4" style="max-width: 700px;">
  <div class="asset-card">
    <div class="form-card-header">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      <h2>Add New Asset</h2>
    </div>
    
    <form method="POST" action="{{ url_for('assets_buy') }}">
      <input type="hidden" name="type" value="Buy">
      
      <div class="form-group-modern">
        <label>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
          Search Asset
        </label>
        <input id="asset_search" name="asset_search" class="form-control form-control-modern" list="master_assets_list" placeholder="Search stocks, forex, gold, real estate..." autocomplete="off" required>
        <datalist id="master_assets_list"></datalist>
        <input type="hidden" name="asset_choice" id="asset_choice">
        <div class="form-text-modern">Start typing to search market assets (stocks, commodities, forex, REITs)</div>
      </div>

      <div class="form-group-modern">
        <label>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" />
          </svg>
          Quantity
        </label>
        <input type="number" step="0.01" name="quantity" id="quantity_input" class="form-control form-control-modern" value="1" required>
        <div class="form-text-modern">Number of units, shares, or contracts</div>
      </div>

      <!-- Price Preview Box -->
      <div id="price_preview_box" class="form-group-modern" style="display: none; background: #f8f9fc; padding: 1rem; border-radius: 8px; border: 2px solid #4e73df;">
        <div style="text-align: center;">
          <div style="font-size: 0.875rem; color: #858796; margin-bottom: 0.5rem;">Current Market Price</div>
          <div id="price_per_unit" style="font-size: 1.5rem; font-weight: 700; color: #4e73df;">--</div>
          <div style="font-size: 0.875rem; color: #858796; margin-top: 1rem; margin-bottom: 0.5rem;">Total Cost</div>
          <div id="total_cost" style="font-size: 2rem; font-weight: 700; color: #1cc88a;">--</div>
          <div id="price_status" class="form-text-modern" style="margin-top: 0.5rem;"></div>
        </div>
      </div>

      <div class="form-group-modern">
        <label>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Total Amount (Optional)
        </label>
        <input type="number" step="0.01" name="amount" id="amount_input" class="form-control form-control-modern" placeholder="Leave blank for auto-calculation">
        <div class="form-text-modern">Leave blank to auto-fetch current price (quantity × market price)</div>
      </div>

      <div class="form-group-modern">
        <label>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          Purchase Date
        </label>
        <input type="date" name="date" class="form-control form-control-modern" required>
      </div>

      <div class="form-group-modern">
        <label>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          Notes (Optional)
        </label>
        <textarea name="note" class="form-control form-control-modern" rows="3" placeholder="Add any additional details about this purchase..."></textarea>
      </div>

      <div class="button-group">
        <button type="submit" class="btn-modern btn-primary-modern">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          Add Asset
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn-modern btn-secondary-modern">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const input = document.getElementById('asset_search');
    const datalist = document.getElementById('master_assets_list');
    const hidden = document.getElementById('asset_choice');
    const map = {};

    const userAssets = JSON.parse('{{ assets|tojson|safe if assets else "[]" }}');
    if (Array.isArray(userAssets)) {
      userAssets.forEach(function(a) {
        const assetTypeCapitalized = a.asset_type ? (a.asset_type.charAt(0).toUpperCase() + a.asset_type.slice(1)) : 'Asset';
        const display = a.name + ' (' + assetTypeCapitalized + ' - ' + a.currency + ')';
        const opt = document.createElement('option'); 
        opt.value = display; 
        datalist.appendChild(opt);
        map[display] = 'u:' + a.id;
      });
    }

    function debounce(fn, wait){
      let t;
      return function(...args){ clearTimeout(t); t = setTimeout(function(){ fn.apply(this, args); }.bind(this), wait); };
    }

    async function searchRemote(q){
      if(!q || q.length < 2) return;
      try{
        const res = await fetch('/api/master-assets?q=' + encodeURIComponent(q) + '&limit=20');
        if(!res.ok) return;
        const data = await res.json();
        Array.from(datalist.options).forEach(function(o) {
          const v = o.value; 
          if(map[v] && map[v].startsWith('m:')) { 
            datalist.removeChild(o); 
            delete map[v]; 
          }
        });
        data.forEach(function(item) {
          const display = item.symbol + ' — ' + item.name + ' (' + item.asset_type + ')';
          const opt = document.createElement('option'); 
          opt.value = display; 
          datalist.appendChild(opt);
          map[display] = 'm:' + item.symbol;
        });
      }catch(e){ }
    }

    const debounced = debounce(searchRemote, 300);
    
    let currentSymbol = null;
    let currentAssetType = null;
    let currentPrice = null;
    
    async function fetchAndDisplayPrice(symbol, assetType) {
      const previewBox = document.getElementById('price_preview_box');
      const pricePerUnit = document.getElementById('price_per_unit');
      const totalCost = document.getElementById('total_cost');
      const priceStatus = document.getElementById('price_status');
      
      previewBox.style.display = 'block';
      pricePerUnit.textContent = 'Loading...';
      totalCost.textContent = 'Loading...';
      priceStatus.textContent = 'Fetching current market price...';
      
      try {
        const res = await fetch(`/api/price/${encodeURIComponent(symbol)}/${encodeURIComponent(assetType)}`);
        if (res.ok) {
          const data = await res.json();
          if (data.price) {
            currentPrice = data.price;
            pricePerUnit.textContent = `$${currentPrice.toFixed(2)}`;
            updateTotalCost();
            priceStatus.textContent = `Live market price for ${symbol}`;
            priceStatus.style.color = '#1cc88a';
          } else {
            throw new Error('Price not available');
          }
        } else {
          throw new Error('Failed to fetch price');
        }
      } catch(e) {
        currentPrice = null;
        pricePerUnit.textContent = 'N/A';
        totalCost.textContent = 'Enter manually';
        priceStatus.textContent = 'Price unavailable - please enter amount manually';
        priceStatus.style.color = '#e74a3b';
      }
    }
    
    function updateTotalCost() {
      const quantity = parseFloat(document.getElementById('quantity_input').value) || 1;
      const totalCost = document.getElementById('total_cost');
      if (currentPrice) {
        const total = quantity * currentPrice;
        totalCost.textContent = `$${total.toFixed(2)}`;
      }
    }
    
    document.getElementById('quantity_input').addEventListener('input', updateTotalCost);
    
    input.addEventListener('input', function(e){
      const v = e.target.value;
      hidden.value = '';
      if(map[v]){
        hidden.value = map[v];
        // Extract symbol and asset type for price fetching
        const choice = map[v];
        if (choice.startsWith('m:')) {
          const symbol = choice.substring(2);
          // Find the asset data to get the type
          const assetData = Object.keys(map).find(key => map[key] === choice);
          if (assetData) {
            const matches = assetData.match(/\(([^)]+)\)$/);
            if (matches) {
              const assetType = matches[1];
              currentSymbol = symbol;
              currentAssetType = assetType;
              fetchAndDisplayPrice(symbol, assetType);
            }
          }
        } else {
          // Hide price preview for existing user assets
          document.getElementById('price_preview_box').style.display = 'none';
        }
      } else {
        debounced(v);
        document.getElementById('price_preview_box').style.display = 'none';
      }
    });

    input.form && input.form.addEventListener('submit', function(e){
      const v = input.value;
      if(map[v]){ hidden.value = map[v]; return true; }
      e.preventDefault();
      alert('Please select a valid asset from the suggestions (type a few letters and pick).');
      return false;
    });
  }());
</script>
{% endblock %}
